# 离线客户端同步机制改进方案

## 当前实现状态

### ✅ 已实现的离线支持

1. **删除记录传播** ✅
   - 删除记录（tombstones）通过文件列表同步传播
   - 离线客户端上线后会收到删除记录并删除本地文件
   - 实现位置：`SyncMessage.swift`, `P2PHandlers.swift`, `SyncEngine.swift`

2. **上线触发同步** ✅
   - 检测到新对等点或对等点上线时，自动触发同步
   - 实现位置：`SyncManager.swift` 第182-202行

3. **Vector Clock 传播** ✅
   - Vector Clock 包含在文件元数据中
   - 离线客户端上线后能收到所有 Vector Clock 更新
   - Vector Clock 合并机制确保因果关系正确

4. **文件列表完整同步** ✅
   - 通过 `getFiles` 请求获取完整的文件列表和删除记录
   - 离线客户端上线后能收到所有文件变更

5. **离线检测机制** ✅
   - 通过广播和连接检查来检测客户端是否在线
   - 30秒窗口容忍UDP丢包

### ⚠️ 需要改进的地方

1. **同步完整性验证**
   - 当前没有机制验证同步是否完整
   - 如果同步过程中断，可能只同步了部分文件

2. **lastKnown 更新时机**
   - `lastKnown` 只在同步成功后才更新
   - 如果同步失败，可能导致状态不一致

3. **删除记录生命周期管理**
   - 删除记录在单个客户端确认后就清理
   - 但其他客户端可能还没收到删除记录

4. **多客户端删除确认**
   - 当前删除确认只检查单个远程客户端
   - 在多客户端场景下，需要所有客户端都确认删除后才能清理

## 改进方案

### 1. 同步完整性验证（高优先级）

**问题**：没有机制确保同步的完整性，如果同步过程中断，可能只同步了部分文件。

**改进**：
- 在同步开始时记录预期同步的文件数量
- 在同步结束时验证实际同步的文件数量
- 如果数量不匹配，标记为不完整并重试

**实现位置**：`SyncEngine.swift` 的 `performSync` 方法

### 2. lastKnown 原子性更新（中优先级）

**问题**：`lastKnown` 只在同步成功后才更新，如果同步失败，可能导致状态不一致。

**改进**：
- 在同步开始时保存当前状态快照
- 只有在同步完全成功后才更新 `lastKnown`
- 如果同步失败，回滚到之前的状态

**实现位置**：`SyncEngine.swift` 的 `performSync` 方法

### 3. 删除记录生命周期管理（中优先级）

**问题**：删除记录在单个客户端确认后就清理，但其他客户端可能还没收到删除记录。

**改进**：
- 删除记录应该保留更长时间（如30天）
- 或者实现多客户端确认机制
- 只有在所有在线客户端都确认删除后才清理

**实现位置**：`SyncManager.swift` 的 `deletedPaths` 管理

### 4. 多客户端删除确认（低优先级）

**问题**：当前删除确认只检查单个远程客户端，在多客户端场景下，需要所有客户端都确认删除后才能清理。

**改进**：
- 记录每个删除记录的确认客户端列表
- 只有在所有在线客户端都确认后才清理
- 或者使用时间窗口（如30天）自动清理

**实现位置**：`StorageManager.swift` 的删除记录存储

## 当前机制总结

### 离线客户端上线流程

1. **检测上线**：
   - 通过广播检测到客户端上线
   - 更新在线状态和 `lastSeenTime`

2. **触发同步**：
   - 新对等点：立即触发所有文件夹的同步
   - 已存在的对等点：检查冷却期，如果不在冷却期内则触发同步

3. **同步过程**：
   - 获取远程文件列表和删除记录
   - 处理远程删除记录，删除本地文件
   - 下载新文件和更新
   - 上传本地变更
   - 更新 `lastKnown` 和元数据

4. **同步完成**：
   - 更新文件夹状态
   - 保存快照
   - 记录同步日志

### 删除操作传播流程

1. **客户端A删除文件**：
   - 检测到本地删除
   - 更新 `deletedPaths`
   - 发送删除请求给在线客户端

2. **客户端B不在线**：
   - 没有收到删除请求
   - 本地文件仍然存在

3. **客户端B上线并同步**：
   - 发送 `getFiles` 请求
   - 收到文件列表和删除记录
   - 根据删除记录删除本地文件
   - 更新本地的 `deletedPaths`

4. **客户端B后续同步**：
   - 检查 `deletedSet`，不会上传已删除的文件
   - 删除记录会传播给其他客户端

## 建议的改进优先级

### 高优先级（立即实现）
1. ✅ 删除记录传播（已完成）
2. ⚠️ 同步完整性验证
3. ⚠️ 离线客户端上线后立即同步（已实现，但可以优化）

### 中优先级（后续改进）
4. ⚠️ lastKnown 原子性更新
5. ⚠️ 删除记录生命周期管理

### 低优先级（可选改进）
6. ⚠️ 多客户端删除确认机制
7. ⚠️ 同步状态持久化

## 测试建议

1. **离线删除测试**：
   - 客户端A删除文件
   - 客户端B离线
   - 客户端B上线
   - 验证文件被删除

2. **离线修改测试**：
   - 客户端A修改文件
   - 客户端B离线
   - 客户端B上线
   - 验证文件被更新

3. **离线创建测试**：
   - 客户端A创建新文件
   - 客户端B离线
   - 客户端B上线
   - 验证文件被下载

4. **同步中断测试**：
   - 开始同步
   - 中断网络连接
   - 恢复网络连接
   - 验证同步完整性

5. **多客户端删除确认测试**：
   - 客户端A删除文件
   - 客户端B和C都在线
   - 客户端B收到删除记录
   - 客户端C离线
   - 客户端C上线
   - 验证删除记录仍然存在
