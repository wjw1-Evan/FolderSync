# FolderSync 软件文档

# 一、软件基础信息

**软件名称**：FolderSync 1.0

**运行平台**：MacOS、Windows

**开发语言**：.NET MAUI C#

**开发人**：樊书译 fsy_008@163.com

**数据库**：SQLite（轻量跨平台数据库，用于存储客户端身份信息、同步配置、文件元数据等）

# 二、核心功能概述

FolderSync 是一款程序常驻式的跨平台 P2P 文件同步软件，核心定位为实现多设备间（含广域网）高效、安全的分布式文件同步与传输；程序不区分主从节点，无需依赖服务器端，只需客户端 ID 和密码相同即可组成同步集群，实现分布式存储与实时同步，支持自定义同步规则、身份认证及网络穿透，适配个人及小型团队的跨网络文件协作需求。

# 三、完善后的系统功能详情

## （一）核心功能补充与增强

### 1. P2P 文件同步功能增强

- 选择性同步策略：支持按文件类型（如 .docx、.jpg 等）、文件大小（过滤超大/小缓存文件）、修改时间（如仅同步近7天修改文件）设置同步规则，满足精细化同步需求。

- 增量同步与差分同步：采用「文件哈希校验+块级差分」技术，仅同步修改的文件片段，大幅减少带宽占用和同步耗时，适配大文件同步场景。

- 同步优先级设置：支持为不同目录/文件设置高、中、低优先级，高优先级文件（如工作文档）优先同步，低优先级文件（如备份文件）空闲时同步。

- 离线同步缓存：客户端离线时自动缓存本地文件修改记录，网络恢复后自动触发增量同步，避免同步遗漏。

- 同步方向与集群特性：因不区分主从节点，默认采用双向同步机制，同 ID 密码集群内所有节点文件实时一致，实现分布式存储冗余，提升数据安全性。

### 2. 文件秒传功能升级

- 多设备同时秒传：支持一对多秒传，单个客户端可向多个在线客户端同时传输同一文件，适配批量分发场景。

- 断点续传：秒传过程中若出现网络中断、程序意外退出，重新连接后可从断点处继续传输，无需重新上传/下载。

- 秒传加速：采用多线程分片传输技术，结合局域网自动发现机制，优先通过局域网传输，规避外网带宽限制。

- 秒传记录与回溯：保存所有秒传操作记录（传输方、接收方、文件名、大小、时间、状态），支持按条件查询，可重新发起历史秒传任务。

### 3. 文件历史版本优化

- 版本留存策略自定义：支持按版本数量（如最多留存10个版本）、时间周期（如留存近30天版本）、文件大小设置清理规则，避免磁盘空间过度占用。

- 版本差异可视化：对文本类文件（.txt、.docx、.csv 等）支持对比不同版本的内容差异，高亮显示新增、删除、修改内容。

- 版本一键恢复与导出：支持直接将指定历史版本恢复为当前版本，或导出为独立文件（不覆盖当前文件），支持批量恢复。

- 版本备注：支持为重要版本添加自定义备注（如“v2.0 最终定稿”），方便快速识别版本用途。

### 4. 客户端身份与同步目录优化

#### （1）客户端身份管理增强

- 无主从节点设计：程序不区分主从，客户端只需 ID 和密码一致，即可自动组成同步集群，实现分布式存储与双向同步，所有节点地位平等。

- 密码安全策略：支持密码复杂度要求（字母+数字+特殊字符）、定期密码修改提醒、密码找回（绑定邮箱/验证问题）；密码变更后，同集群所有节点需重新验证一致方可继续同步。

- 集群设备管理：支持查看当前同 ID 密码集群下的所有绑定设备（设备名称、系统版本、登录时间、在线状态），可远程吊销异常设备的登录权限，移除后设备将退出同步集群。

#### （2）同步目录管理增强

- 多目录同步：支持添加多个本地目录同时同步，不同目录可配置独立的同步规则（同步频率、文件过滤条件等）。

- 目录备份与迁移：支持快速备份同步目录配置，本地目录路径变更时可一键迁移配置，无需重新设置。

- 同步目录容量监控：实时监控各同步目录的磁盘占用情况，磁盘空间不足时及时提醒，支持快速清理无用文件/历史版本。

## （二）新增核心功能

### 1. 实时同步监控与通知

- 同步状态与进度实时可视化：提供桌面悬浮窗/系统托盘图标，直观显示当前同步进度（含整体同步进度百分比、单个文件同步进度）、待同步文件数量、传输速度，支持点击快速进入同步详情页面查看详细进度列表（含文件名、已传输大小、剩余时间）。

- 异常通知提醒：同步失败（文件被占用、权限不足等）、磁盘空间不足、设备离线/上线时，通过系统通知、弹窗或邮件推送提醒，支持自定义触发条件。

- 同步日志查询：保存所有同步操作的详细日志（成功/失败记录、文件路径、错误原因、处理时间），支持按时间、状态、文件名筛选查询。

### 2. 冲突文件处理机制

- 智能冲突检测：通过文件修改时间、哈希值精准识别冲突文件，避免误判。

- 多冲突解决方案：支持自动合并（文本类文件非重叠区域）、保留双方版本（分别命名保存）、按优先级覆盖（自定义优先级规则）。

- 冲突记录追溯：保存所有冲突文件的处理记录，支持查看详情、重新处理已解决的冲突文件。

### 3. 离线模式与本地缓存管理

- 全功能离线模式：离线时可正常访问本地同步目录文件，修改操作自动缓存，网络恢复后自动同步变更内容。

- 缓存容量自定义：支持设置本地缓存最大容量，达到阈值时自动清理最久未同步的非核心文件缓存（可自定义规则）。

- 缓存手动同步/清理：支持手动触发缓存同步，也可手动清理无效缓存（如已取消同步的文件缓存、过期缓存）。

### 4. 跨平台兼容与文件适配

- 跨系统文件属性兼容：自动适配 MacOS 与 Windows 的文件属性差异（权限、隐藏属性、创建时间格式），确保同步后文件可正常访问。

- 特殊文件处理：支持同步快捷方式（MacOS 替身/Windows 快捷方式）、符号链接，自动过滤系统锁定文件、临时文件。

- 大文件支持：优化 GB 级大文件的同步与秒传性能，采用分片存储与传输，避免内存溢出。

### 5. 权限精细化管理

- 文件级权限控制：支持对单个文件/文件夹设置同步权限（仅读取、可读写、禁止同步），满足敏感文件不参与同步的需求。

- 用户权限分级：支持「管理员」「普通用户」角色，管理员可管理同 ID 密码集群内所有客户端、同步规则、权限配置；普通用户仅可修改自身客户端配置，无法变更集群全局设置。

- 访问权限验证：本地同步目录支持设置访问密码，远端同步需验证设备授权与文件权限。

### 6. 自动化任务与自动同步

- 文件自动同步：实时监控同步目录文件变更，自动触发同步操作；支持自定义同步触发阈值（如文件修改后延迟3秒同步，避免频繁触发）。

- 自动化清理任务：按预设规则自动清理无用文件（同步失败的临时文件、过期历史版本、空文件夹）。

## （三）性能优化功能

- 后台低资源占用与启动设置：程序支持常驻后台运行，用户可自定义设置是否随系统自动启动；常驻时自动降低 CPU、内存占用率（休眠唤醒机制），不影响主机其他程序运行，优化笔记本续航。

- P2P 节点优化与网络穿透增强：基于 LibP2P.NET 优化无服务器节点发现效率，自动筛选优质 P2P 节点（低延迟、高带宽）并优先建立连接；支持手动添加固定节点，适配复杂内网环境；内置 UPnP/IGD 端口映射机制，无需依赖服务器即可实现网络穿透，保障广域网环境下设备稳定连接与跨网络同步。

- 内存优化：采用内存缓存池、对象复用技术，减少大文件传输时的内存占用，避免程序崩溃；自动释放无用内存。

- 磁盘 IO 优化：采用批量读写、异步 IO 技术，减少磁盘频繁读写，提升同步速度，降低磁盘损耗。

## （四）安全保障功能

- 端到端加密传输：所有 P2P 传输的文件与数据（同步配置、用户信息）采用 AES-256 加密算法端到端加密，确保传输安全。

- 文件哈希校验：文件传输前后通过 SHA256 算法计算哈希值，验证文件完整性，避免传输损坏。

- 敏感信息加密存储：客户端 ID、密码等敏感信息加密后存入本地 SQLite 数据库，防止明文泄露。

- 异常行为监控：实时监控异常登录、频繁同步失败、超大文件异常传输等行为，触发预警并记录日志。

# 四、核心技术选型

## 1. 基础框架

采用 .NET MAUI 作为跨平台核心框架，实现一套代码适配 MacOS、Windows 双平台，无需依赖服务器端即可独立运行；支持系统托盘（常驻功能）、用户自定义开机自动启动设置、文件系统操作、UI 界面构建等核心能力，适配 MacOS 菜单栏与 Windows 系统托盘的常驻展示形式。

## 2. P2P 通信核心库

推荐使用 LibP2P.NET（LibP2P 的 .NET 移植版），该库完美适配 FolderSync 的无服务器分布式同步需求，核心优势如下：1. 节点发现与分布式能力：原生支持 DHT 分布式哈希表，可实现广域网无服务器节点发现，同时兼容局域网组播/广播探测机制；2. 扩展性与定制化：支持自定义协议封装，能灵活实现同步指令、身份认证、文件传输等专属消息格式；3. 跨网络穿透适配：与 UPnP/IGD 端口映射机制兼容性优异，可稳定实现广域网穿透；4. 社区与生态成熟：拥有跨语言生态及专业维护团队，问题解决方案丰富。其原生支持 P2P 节点发现、连接与通信，无需依赖任何服务器端；节点发现核心实现方式包括：1. 局域网发现：通过组播/广播机制，同一局域网内同 ID 密码客户端自动探测并建立连接；2. 广域网发现：结合 DHT（分布式哈希表）网络与 UPnP/IGD 端口映射，节点通过分布式哈希表查询获取目标节点外网地址，实现跨网络发现；3. 手动辅助发现：支持用户手动添加固定节点（IP+端口），适配复杂网络环境。内置网络穿透能力，通过 UPnP/IGD 协议自动映射端口，可轻松实现广域网设备间的同步与秒传，彻底解决内网穿透问题；支持自定义协议，可封装文件传输、同步指令等专属消息格式；提供数据分片传输、断点续传能力，与 .NET MAUI 无缝集成。

## 3. 文件操作与监控

- 文件系统监控：使用 FileSystemWatcher 或 Microsoft.Extensions.FileSystemGlobbing，实时监控同步目录的文件操作，触发同步事件。

- 文件哈希计算：采用 SHA256 算法计算文件唯一哈希值，用于秒传对比、版本校验、完整性验证。

## 4. 数据持久化存储

|存储内容|推荐技术|说明|
|---|---|---|
|客户端 ID、密码（加密存储）|.NET 加密库 + SQLite|身份信息加密后存入本地数据库，防止明文泄露|
|同步目录配置、节点信息|SQLite|轻量跨平台，无需额外依赖|
|文件历史版本|本地文件目录 + 元数据数据库|历史版本按“文件名_版本号_时间戳”归档，元数据存入 SQLite|
|临时传输文件|本地临时目录|传输分片文件暂存，完成后移动至目标目录|

