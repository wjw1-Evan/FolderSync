# macOSæ— æœåŠ¡å™¨æ–‡ä»¶å¤¹è‡ªåŠ¨åŒæ­¥å®¢æˆ·ç«¯è®¾è®¡æ–¹æ¡ˆï¼ˆSwiftï¼‰

# ä¸€ã€é¡¹ç›®æ¦‚è¿°

## æ ¸å¿ƒåŠŸèƒ½

**å®¢æˆ·ç«¯ä¹‹é—´æ–‡ä»¶è‡ªåŠ¨åŒæ­¥**ï¼šå®ç°å¤šå° macOS è®¾å¤‡ä¹‹é—´çš„æ–‡ä»¶å¤¹è‡ªåŠ¨åŒæ­¥ï¼Œæ— éœ€ä¸­å¤®æœåŠ¡å™¨ã€‚å½“ä¸€å°è®¾å¤‡ä¸Šçš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå…¶ä»–è®¾å¤‡ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶åŒæ­¥æ›´æ–°ï¼Œç¡®ä¿æ‰€æœ‰è®¾å¤‡ä¸Šçš„æ–‡ä»¶ä¿æŒä¸€è‡´ã€‚

## é¡¹ç›®æè¿°

æœ¬é¡¹ç›®æ˜¯ä¸€æ¬¾åŸºäº macOS å¹³å°çš„å®¢æˆ·ç«¯ç¨‹åºï¼Œé‡‡ç”¨ Swift è¯­è¨€ç¼–å†™ï¼Œé€šè¿‡ P2Pï¼ˆç‚¹å¯¹ç‚¹ï¼‰æŠ€æœ¯å®ç°å¤šå°ç”µè„‘ä¹‹é—´æ–‡ä»¶å¤¹çš„è‡ªåŠ¨åŒæ­¥ï¼Œå…¨ç¨‹æ— éœ€ä¾èµ–ä¸­å¤®æœåŠ¡å™¨ã€‚ç¨‹åºå…·å¤‡è®¾å¤‡è‡ªåŠ¨å‘ç°ã€å®æ—¶æ–‡ä»¶ç›‘æ§ã€åŸºäºå†…å®¹å—çš„å¢é‡åŒæ­¥ã€ç«¯åˆ°ç«¯åŠ å¯†ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œå…¼é¡¾åŒæ­¥æ•ˆç‡ã€æ•°æ®å®‰å…¨ä¸ç”¨æˆ·ä½“éªŒï¼Œé€‚ç”¨äºå®¶åº­ã€å°å‹å›¢é˜Ÿç­‰åœºæ™¯ä¸‹çš„å¤šè®¾å¤‡æ–‡ä»¶ååŒç®¡ç†ã€‚

> è¿è¡Œæç¤ºï¼šå±€åŸŸç½‘è‡ªåŠ¨å‘ç°å·²å¯ç”¨ï¼ˆåŸºäº UDP å¹¿æ’­ï¼‰ã€‚è¯·ç¡®ä¿å„å®¢æˆ·ç«¯å‡è¿æ¥åŒä¸€å­ç½‘ä»¥è¿›è¡Œè‡ªåŠ¨å‘ç°ã€‚å¦‚æœè‡ªåŠ¨å‘ç°å¤±è´¥ï¼Œç”¨æˆ·ä»å¯é€šè¿‡åˆ†äº« PeerID æ‰‹åŠ¨è¿æ¥è®¾å¤‡ã€‚

æ ¸å¿ƒç›®æ ‡ï¼š
- **è‡ªåŠ¨åŒæ­¥**ï¼šå®¢æˆ·ç«¯ä¹‹é—´è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å˜åŒ–å¹¶åŒæ­¥ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
- **æ— æœåŠ¡å™¨æ¶æ„**ï¼šæ‰“ç ´æœåŠ¡å™¨ä¾èµ–ï¼Œå®ç°è®¾å¤‡é—´ç›´è¿åŒæ­¥
- **å¤šè®¾å¤‡åä½œ**ï¼šæ”¯æŒå¤šè®¾å¤‡åŒæ—¶åœ¨çº¿åä½œ
- **å®æ—¶æ€§**ï¼šé€šè¿‡ FSEvents å®æ—¶ç›‘æ§æ–‡ä»¶å˜åŒ–ï¼Œå¿«é€ŸåŒæ­¥
- **ä¸€è‡´æ€§**ï¼šé€šè¿‡ MST å’Œ Vector Clocks ä¿è¯æ–‡ä»¶åŒæ­¥çš„ä¸€è‡´æ€§
- **å®‰å…¨æ€§**ï¼šç«¯åˆ°ç«¯åŠ å¯†ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“å®‰å…¨
- **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›ç®€æ´ç›´è§‚çš„ macOS åŸç”Ÿ GUI äº¤äº’

# äºŒã€æ ¸å¿ƒæŠ€æœ¯é€‰å‹

## 1. å¼€å‘ç¯å¢ƒä¸è¯­è¨€

- å¼€å‘è¯­è¨€ï¼šSwift 5.9+ï¼Œåˆ©ç”¨Swift Concurrencyï¼ˆasync/awaitï¼‰ã€Combineæ¡†æ¶å®ç°å¼‚æ­¥ä»»åŠ¡ä¸äº‹ä»¶é©±åŠ¨ï¼Œé€‚é…macOS 14+ç³»ç»Ÿç‰ˆæœ¬ã€‚
- å¼€å‘å·¥å…·ï¼šXcode 15+ï¼Œä½¿ç”¨SwiftUIæ„å»ºGUIã€‚
- ä¾èµ–ç®¡ç†ï¼šSwift Package Manager (SPM)ã€‚

## 2. æ ¸å¿ƒæŠ€æœ¯æ¨¡å—

- **P2Pé€šä¿¡ (libp2p)**ï¼šé›†æˆ **libp2p** æ¡†æ¶ï¼Œä½¿ç”¨ UDP å¹¿æ’­å®ç°å±€åŸŸç½‘è‡ªåŠ¨å‘ç°ï¼Œæ”¯æŒ Kademlia DHT è¿›è¡Œå¹¿åŸŸç½‘å‘ç°ã€‚é€šè¿‡ AutoNAT å’Œ Circuit Relay (v2) è§£å†³å¤æ‚çš„ NAT ç©¿é€é—®é¢˜ï¼ˆå¼€å‘ä¸­ï¼‰ï¼Œé€šè¿‡ Noise åè®®ä¿éšœä¼ è¾“å®‰å…¨ã€‚
- **ç³»ç»Ÿé›†æˆ (ServiceManagement)**ï¼šåˆ©ç”¨ `ServiceManagement` æ¡†æ¶ï¼ˆ`SMAppService`ï¼‰å®ç°ç”¨æˆ·å¯æ§çš„â€œå¼€æœºè‡ªåŠ¨å¯åŠ¨â€åŠŸèƒ½ã€‚
- **æ–‡ä»¶ç›‘æ§ (FSEvents)**ï¼šåˆ©ç”¨ macOS åŸç”Ÿ FSEvents API å®ç°é«˜æ•ˆçš„ç›®å½•é€’å½’ç›‘æ§ï¼Œæ•è·æ–‡ä»¶åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ã€é‡å‘½åç­‰äº‹ä»¶ã€‚
- **å¢é‡åŒæ­¥ (CDC & Merkle Search Trees)**ï¼š
    - **å†…å®¹å®šä¹‰åˆ‡åˆ† (CDC)**ï¼šä½¿ç”¨ FastCDC ç®—æ³•å°†æ–‡ä»¶åˆ‡åˆ†ä¸ºå˜é•¿æ•°æ®å—ï¼Œæé«˜æ•°æ®å»é‡ç‡å¹¶è§£å†³â€œæ’å…¥/åˆ é™¤å­—èŠ‚å¯¼è‡´åç§»å¤±æ•ˆâ€çš„é—®é¢˜ã€‚
    - **çŠ¶æ€åŒæ­¥ (MST)**ï¼šä½¿ç”¨ **Merkle Search Trees (MST)** ç»´æŠ¤é›†ç¾¤çŠ¶æ€ï¼Œé€šè¿‡å¯¹æ¯”æ ‘å“ˆå¸Œåœ¨ $O(\log n)$ æ—¶é—´å†…å¿«é€Ÿå®šä½å·®å¼‚æ–‡ä»¶ã€‚
- **ä¸€è‡´æ€§ä¸å†²çªå¤„ç†**ï¼šä½¿ç”¨ **Vector Clocks** è¿½è¸ªæ–‡ä»¶å˜æ›´çš„å› æœå…³ç³»ã€‚å†²çªå‘ç”Ÿæ—¶ï¼Œä¿ç•™å¤šç‰ˆæœ¬ï¼ˆç”±ç”¨æˆ·æ‰‹åŠ¨æˆ–æŒ‰ç­–ç•¥è‡ªåŠ¨è§£å†³ï¼‰ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±ã€‚
- **èº«ä»½éªŒè¯ä¸åŠ å¯†**ï¼š
    - **è®¾å¤‡èº«ä»½**ï¼šæ¯ä¸ªè®¾å¤‡åœ¨é¦–æ¬¡å¯åŠ¨æ—¶ç”Ÿæˆéšæœº Ed25519 å¯†é’¥å¯¹ï¼ŒPeerID ä½œä¸ºå…¨çƒå”¯ä¸€æ ‡è¯†ã€‚
    - **è‡ªåŠ¨è®¤è¯**ï¼šè®¾å¤‡é€šè¿‡ libp2p çš„ Noise åè®®è‡ªåŠ¨è¿›è¡Œç›¸äº’è®¤è¯ï¼Œæ— éœ€æ‰‹åŠ¨é…å¯¹ã€‚
    - **Noise åè®®**ï¼šåŸºäº Noise Protocol Framework å®ç°ç«¯åˆ°ç«¯åŠ å¯†ä¿¡é“ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“å®‰å…¨ã€‚
- **åŠ å¯†æœºåˆ¶**ï¼šé‡‡ç”¨ç«¯åˆ°ç«¯åŠ å¯† (E2EE)ï¼Œä½¿ç”¨ Noise åè®®åŠ å¯†ä¼ è¾“é“¾è·¯ï¼Œæœ¬åœ°å…ƒæ•°æ®åŠ å¯†å­˜å‚¨åœ¨ macOS Keychainã€‚

# ä¸‰ã€ç³»ç»Ÿæ¶æ„è®¾è®¡

## 1. æ•´ä½“æ¶æ„ï¼ˆåˆ†å±‚è®¾è®¡ï¼‰

é‡‡ç”¨ **å•è¿›ç¨‹åº”ç”¨æ¶æ„**ï¼Œå„å±‚é€šè¿‡ç›´æ¥è°ƒç”¨å’Œ Swift Concurrency è¿›è¡Œé€šä¿¡ï¼š

1. **è¡¨ç°å±‚ (SwiftUI Client)**ï¼šæä¾›è®¾å¤‡ç®¡ç†ã€åŒæ­¥æ–‡ä»¶å¤¹é…ç½®ã€çŠ¶æ€å®æ—¶ç›‘æ§ã€å†²çªè§£å†³ç­‰ç•Œé¢ã€‚
2. **ä¸šåŠ¡é€»è¾‘å±‚ (Sync Engine)**ï¼šè´Ÿè´£æ–‡ä»¶ç´¢å¼•ç®¡ç†ã€å› æœè¿½è¸ªã€å†²çªç­–ç•¥æ‰§è¡Œã€åŒæ­¥ä»»åŠ¡è°ƒåº¦ã€‚é€šè¿‡ `@MainActor` å’Œ `ObservableObject` ä¸ UI å±‚è¿›è¡ŒçŠ¶æ€åŒæ­¥ã€‚
3. **ç½‘ç»œå±‚ (libp2p Wrapper)**ï¼šå°è£…åº•å±‚ P2P é€»è¾‘ï¼ŒåŒ…æ‹¬å¯¹ç­‰ç‚¹å‘ç°ã€è¿æ¥ç®¡ç†ã€å¤šè·¯å¤ç”¨ä¸å®‰å…¨æ€§ä¿éšœã€‚é€šè¿‡å¼‚æ­¥å›è°ƒä¸ä¸šåŠ¡é€»è¾‘å±‚é€šä¿¡ã€‚
4. **å­˜å‚¨å±‚ (Metadata Storage)**ï¼šä½¿ç”¨ SQLite (WAL mode) å­˜å‚¨æ–‡ä»¶ç´¢å¼•ã€å—ä¿¡æ¯ã€è®¾å¤‡çŠ¶æ€ä¸åŒæ­¥æ—¥å¿—ã€‚

## 2. æ ¸å¿ƒæ¨¡å—è¯¦è§£

### ï¼ˆ1ï¼‰ç½‘ç»œä¸è®¾å¤‡å‘ç° (libp2p)
- **å±€åŸŸç½‘è‡ªåŠ¨å‘ç°**ï¼šä½¿ç”¨ UDP å¹¿æ’­åœ¨å±€åŸŸç½‘å†…è‡ªåŠ¨å‘ç°å…¶ä»–è®¾å¤‡ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚è®¾å¤‡æ¯ 5 ç§’å¹¿æ’­ä¸€æ¬¡è‡ªå·±çš„ PeerIDï¼Œå¹¶ç›‘å¬å…¶ä»–è®¾å¤‡çš„å¹¿æ’­æ¶ˆæ¯ã€‚è¿™æ˜¯ä¸»è¦çš„è®¾å¤‡å‘ç°æœºåˆ¶ï¼Œå®Œå…¨åœ¨å±€åŸŸç½‘å†…å·¥ä½œï¼Œæ— éœ€ä»»ä½•æœåŠ¡å™¨ã€‚
- **è‡ªåŠ¨è¿æ¥**ï¼šå‘ç°è®¾å¤‡åè‡ªåŠ¨å»ºç«‹è¿æ¥å¹¶å¼€å§‹åŒæ­¥ï¼Œæ— éœ€ä»»ä½•æ‰‹åŠ¨é…å¯¹æ­¥éª¤ã€‚æ‰€æœ‰é€šä¿¡å‡åœ¨å®¢æˆ·ç«¯ä¹‹é—´ç›´æ¥è¿›è¡Œï¼ˆP2Pï¼‰ï¼Œæ— éœ€ä¸­å¤®æœåŠ¡å™¨ã€‚
- **çº¯ P2P æ¶æ„**ï¼šå®¢æˆ·ç«¯ä¹‹é—´é€šè¿‡ libp2p åè®®ç›´æ¥é€šä¿¡ï¼Œæ‰€æœ‰æ•°æ®ä¼ è¾“éƒ½åœ¨è®¾å¤‡é—´ç›´è¿å®Œæˆï¼Œä¸ç»è¿‡ä»»ä½•ä¸­é—´æœåŠ¡å™¨ã€‚
- **å¯¹ç­‰ç‚¹èº«ä»½**ï¼šåŸºäº Ed25519 å¯†é’¥å¯¹ç”Ÿæˆ PeerIDï¼Œä½œä¸ºè®¾å¤‡å”¯ä¸€èº«ä»½æ ‡è¯†ã€‚
- **æœªæ¥æ‰©å±•**ï¼šå¯é€‰çš„å¹¿åŸŸç½‘å‘ç°åŠŸèƒ½ï¼ˆDHTï¼‰å·²é¢„ç•™æ¥å£ï¼Œä½†å½“å‰ç‰ˆæœ¬ä¸“æ³¨äºå±€åŸŸç½‘å†…çš„æ— æœåŠ¡å™¨ P2P åŒæ­¥ã€‚

### ï¼ˆ2ï¼‰å†…å®¹å®šä¹‰å—ç®¡ç† (Block Management)
- **FastCDC ç®—æ³•**ï¼šå·²å®ç° FastCDC ç®—æ³•ç”¨äºæ–‡ä»¶å†…å®¹å®šä¹‰åˆ‡åˆ†ï¼Œä¸ºæœªæ¥çš„å—çº§åˆ«åŒæ­¥ä¼˜åŒ–åšå‡†å¤‡ã€‚
- **å½“å‰å®ç°**ï¼šå½“å‰ç‰ˆæœ¬é‡‡ç”¨æ–‡ä»¶çº§åˆ«çš„åŒæ­¥ï¼Œé€šè¿‡æ–‡ä»¶å“ˆå¸Œå¯¹æ¯”å¿«é€Ÿè¯†åˆ«éœ€è¦åŒæ­¥çš„æ–‡ä»¶ã€‚
- **æœªæ¥ä¼˜åŒ–**ï¼šè®¡åˆ’å®ç°å—çº§åˆ«çš„å»é‡å­˜å‚¨å’Œå¢é‡ä¼ è¾“ï¼Œè¿›ä¸€æ­¥æå‡å¤§æ–‡ä»¶åŒæ­¥æ•ˆç‡ã€‚

### ï¼ˆ3ï¼‰å·®åˆ†åŒæ­¥ (MST-based Diff)
- **å¢é‡åˆ—è¡¨åŒæ­¥**ï¼šç›¸æ¯”å…¨é‡å‘é€æ–‡ä»¶åˆ—è¡¨ï¼ŒMST ä»…åœ¨åˆ†æ”¯å“ˆå¸Œä¸ä¸€è‡´æ—¶é€’å½’å‘ä¸‹æ¢æµ‹ï¼Œæå¤§ç¨‹åº¦èŠ‚çœå…ƒæ•°æ®äº¤æ¢å¸¦å®½ã€‚

### ï¼ˆ4ï¼‰èº«ä»½éªŒè¯ä¸å®‰å…¨
- **è‡ªåŠ¨èº«ä»½éªŒè¯**ï¼šè®¾å¤‡é€šè¿‡ libp2p çš„ Noise åè®®è‡ªåŠ¨è¿›è¡Œèº«ä»½éªŒè¯å’ŒåŠ å¯†è¿æ¥ã€‚
- **ç«¯åˆ°ç«¯åŠ å¯†**ï¼šæ‰€æœ‰æ•°æ®ä¼ è¾“ä½¿ç”¨ Noise åè®®åŠ å¯†ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ã€‚
- **æœ¬åœ°å­˜å‚¨å®‰å…¨æ€§**ï¼šç§é’¥å­˜å‚¨åœ¨ macOS Keychain ä¸­ï¼Œç¡®ä¿ç¡¬ä»¶çº§åˆ«çš„å®‰å…¨æ€§ã€‚

# å››ã€GUI ç•Œé¢è®¾è®¡

1. **ä»ªè¡¨ç›˜ (Dashboard)**ï¼šæ˜¾ç¤ºæ•´ä½“åŒæ­¥è¿›åº¦ã€å®æ—¶ä¸Šä¼ /ä¸‹è½½é€Ÿåº¦ã€è¿æ¥å¯¹ç­‰ç‚¹æ•°é‡ã€‚
2. **æ–‡ä»¶å¤¹ç®¡ç†ä¸­å¿ƒ**ï¼š
    - **å¤šæ–‡ä»¶å¤¹æ”¯æŒ**ï¼šåˆ—è¡¨åŒ–ç®¡ç†å¤šä¸ªåŒæ­¥æ–‡ä»¶å¤¹ã€‚ç”¨æˆ·å¯ä¸ºæ¯ä¸ªæ–‡ä»¶å¤¹åˆ†é…å”¯ä¸€çš„â€œåŒæ­¥ IDâ€ï¼Œç”¨äºè·¨è®¾å¤‡å…³è”ã€‚
    - **é€‰æ‹©æ€§åŒæ­¥**ï¼šæ”¯æŒé…ç½®ç‹¬ç«‹çš„æ’é™¤è§„åˆ™ï¼ˆ`.gitignore` é£æ ¼ï¼‰åŠåŒæ­¥æ¨¡å¼ï¼ˆåŒå‘/å•å‘ï¼‰ã€‚
3. **å¯¹ç­‰ç‚¹è§†å›¾**ï¼šå±•ç¤ºå·²çŸ¥è®¾å¤‡åˆ—è¡¨ï¼Œæ ‡è®°è¿æ¥è·¯å¾„ï¼ˆç›´è¿/Relayï¼‰åŠåŒæ­¥åç§»é‡ã€‚
4. **ç‰ˆæœ¬/å†²çªä¸­å¿ƒ**ï¼šå±•ç¤ºå˜æ›´å†å²åŠéœ€è¦æ‰‹åŠ¨ä»‹å…¥çš„å†²çªæ–‡ä»¶ã€‚
5. **èœå•æ å¸¸é©» (Menu Bar Extra)**ï¼š
    - å¿«é€Ÿæ‰“å¼€ä¸»çª—å£ã€é€€å‡ºç¨‹åºã€‚
    - å¼€å¯/å…³é—­"å¼€æœºè‡ªåŠ¨å¯åŠ¨"åŠŸèƒ½ã€‚

# äº”ã€ä»£ç å®ç°æ–¹æ¡ˆ (æ ¸å¿ƒé€»è¾‘)

### ï¼ˆ1ï¼‰libp2p èŠ‚ç‚¹åˆå§‹åŒ–ä¸å±€åŸŸç½‘å‘ç°
```swift
class P2PNode {
    private var app: Application?
    private var lanDiscovery: LANDiscovery?

    func start() async throws {
        let app = try await Application.make(.development, peerID: keyPairFile)
        app.listen(.tcp(host: "0.0.0.0", port: 0))
        
        // å¯ç”¨ UDP å¹¿æ’­å±€åŸŸç½‘å‘ç°
        let discovery = LANDiscovery()
        discovery.onPeerDiscovered = { peerID, address in
            // å¤„ç†å‘ç°çš„è®¾å¤‡
        }
        discovery.start(peerID: app.peerID.b58String)
        
        // æ³¨å†Œ libp2p çš„å‘ç°äº‹ä»¶
        app.discovery.onPeerDiscovered { peerInfo in
            // è‡ªåŠ¨è¿æ¥å¹¶åŒæ­¥
        }
    }
}
```

### ï¼ˆ2ï¼‰CDC å—åˆ‡åˆ†é€»è¾‘
```swift
func processFileContent(url: URL) throws -> [BlockID] {
    let rawData = try Data(contentsOf: url)
    let chunks = FastCDC.chunk(data: rawData, min: 4KB, avg: 16KB, max: 64KB)
    return chunks.map { chunk in
        let id = SHA256.hash(data: chunk)
        Storage.shared.storeBlock(id: id, content: chunk)
        return id
    }
}
```

### ï¼ˆ3ï¼‰ç³»ç»Ÿé›†æˆï¼šèœå•æ ä¸å¼€æœºå¯åŠ¨
```swift
// èœå•æ å®šä¹‰
@main
struct FolderSyncApp: App {
    var body: some Scene {
        WindowGroup {
            MainView()
        }
        MenuBarExtra("FolderSync", systemImage: "arrow.triangle.2.circlepath") {
            Button("æ˜¾ç¤ºä¸»ç•Œé¢") { /* å±•ç¤ºçª—å£ */ }
            Divider()
            Toggle("å¼€æœºè‡ªåŠ¨å¯åŠ¨", isOn: $isLaunchAtLoginEnabled)
                .onChange(of: isLaunchAtLoginEnabled) { enabled in
                    toggleLaunchAtLogin(enabled)
                }
            Button("é€€å‡º") { NSApplication.shared.terminate(nil) }
        }
    }
}

// å¼€æœºå¯åŠ¨æ§åˆ¶ (macOS 13+)
func toggleLaunchAtLogin(_ enabled: Bool) {
    let service = SMAppService.mainApp
    do {
        if enabled {
            try service.register()
        } else {
            try service.unregister()
        }
    } catch {
        print("è®¾ç½®å¼€æœºå¯åŠ¨å¤±è´¥: \(error)")
    }
}
```

### ï¼ˆ4ï¼‰å±€åŸŸç½‘å‘ç°å®ç°
```swift
// UDP å¹¿æ’­å±€åŸŸç½‘å‘ç°
class LANDiscovery {
    private let servicePort: UInt16 = 8765
    
    func start(peerID: String) {
        // å¯åŠ¨ UDP ç›‘å¬
        let listener = try NWListener(using: .udp, on: servicePort)
        listener.newConnectionHandler = { connection in
            // æ¥æ”¶å…¶ä»–è®¾å¤‡çš„å¹¿æ’­æ¶ˆæ¯
        }
        
        // å®šæœŸå¹¿æ’­æœ¬æœº PeerID
        Timer.scheduledTimer { _ in
            self.sendBroadcast(peerID: peerID)
        }
    }
    
    private func sendBroadcast(peerID: String) {
        // å‘ 255.255.255.255 å¹¿æ’­ PeerID
        let message = createDiscoveryMessage(peerID: peerID)
        // å‘é€ UDP å¹¿æ’­
    }
}
```

### ï¼ˆ5ï¼‰å¤šæ–‡ä»¶å¤¹é…ç½®æ¨¡å‹
```swift
struct SyncFolder: Identifiable, Codable {
    let id: UUID // æœ¬åœ°æ ‡è¯†ç¬¦
    let syncID: String // å…¨å±€å”¯ä¸€åŒæ­¥ ID (Link ID)
    var localPath: URL // æœ¬åœ°ç‰©ç†è·¯å¾„
    var mode: SyncMode // .twoWay, .uploadOnly, .downloadOnly
    var status: SyncStatus // .synced, .syncing, .error, .paused
    var syncProgress: Double = 0.0 // åŒæ­¥è¿›åº¦
    var lastSyncMessage: String? // æœ€ååŒæ­¥æ¶ˆæ¯
    var lastSyncedAt: Date? // æœ€ååŒæ­¥æ—¶é—´
    var peerCount: Int = 0 // å‚ä¸åŒæ­¥çš„å¯¹ç­‰ç«¯æ•°é‡
    var fileCount: Int? = 0 // æ–‡ä»¶æ•°é‡
}

@MainActor
class SyncManager: ObservableObject {
    @Published var folders: [SyncFolder] = []
    @Published var peers: [PeerID] = [] // å·²å‘ç°çš„å¯¹ç­‰ç«¯
    var folderPeers: [String: Set<String>] = [:] // SyncID -> PeerIDs æ˜ å°„

    func addFolder(_ folder: SyncFolder) {
        folders.append(folder)
        try? StorageManager.shared.saveFolder(folder)
        startMonitoring(folder)
        // å¯åŠ¨åŒæ­¥ä»»åŠ¡
        triggerSync(for: folder)
    }
}
```

# å…­ã€é£é™©ä¸åº”å¯¹

- **æ€§èƒ½å¼€é”€**ï¼šå¤§é‡å°æ–‡ä»¶çš„ MST æ„å»ºå¯èƒ½å¯¼è‡´ CPU/IO å‹åŠ›ã€‚*åº”å¯¹ï¼šå¼•å…¥å¼‚æ­¥ç´¢å¼•æ›´æ–°æœºåˆ¶ï¼Œåˆ†æ‰¹æ¬¡å†™å…¥ SQLiteã€‚*
- **ç½‘è·¯æ³¢åŠ¨**ï¼šå¹¿åŸŸç½‘é«˜ä¸¢åŒ…ç‡ã€‚*åº”å¯¹ï¼šå¯ç”¨ libp2p çš„ QUIC ä¼ è¾“ï¼Œåˆ©ç”¨å…¶å¤šè·¯å¤ç”¨å’Œæ‹¥å¡æ§åˆ¶ã€‚*
- **æ²™ç›’æƒé™**ï¼šmacOS App Sandboxã€‚*åº”å¯¹ï¼šä½¿ç”¨ Security-Scoped Bookmarks ä¿æŒæ–‡ä»¶å¤¹è®¿é—®æƒé™ã€‚*

# ä¸ƒã€å½“å‰å®ç°çŠ¶æ€

## å·²å®ç°åŠŸèƒ½
- âœ… å±€åŸŸç½‘è‡ªåŠ¨å‘ç°ï¼ˆUDP å¹¿æ’­ï¼‰
- âœ… è‡ªåŠ¨è®¾å¤‡è¿æ¥å’ŒåŒæ­¥
- âœ… åŒå‘æ–‡ä»¶åŒæ­¥
- âœ… Vector Clock å†²çªæ£€æµ‹
- âœ… å†²çªæ–‡ä»¶å¤šç‰ˆæœ¬ä¿ç•™
- âœ… æ–‡ä»¶åˆ é™¤åŒæ­¥
- âœ… å®æ—¶æ–‡ä»¶ç›‘æ§ï¼ˆFSEventsï¼‰
- âœ… MST çŠ¶æ€å¯¹æ¯”
- âœ… åŒæ­¥æ¨¡å¼é…ç½®ï¼ˆåŒå‘/ä»…ä¸Šä¼ /ä»…ä¸‹è½½ï¼‰
- âœ… æ’é™¤è§„åˆ™é…ç½®
- âœ… åŒæ­¥å†å²è®°å½•
- âœ… å†²çªè§£å†³ç•Œé¢

## å¼€å‘ä¸­åŠŸèƒ½
- ğŸš§ AutoNAT å’Œ Circuit Relay
- ğŸš§ å—çº§åˆ«å¢é‡åŒæ­¥ï¼ˆFastCDCï¼‰

# å…«ã€æ€»ç»“

æœ¬æ–¹æ¡ˆé€šè¿‡å¼•å…¥ **libp2p** å’Œ **CDC åŒæ­¥æ¨¡å‹**ï¼Œå®ç°äº†æ›´ç¨³å¥ã€æ›´é«˜æ•ˆçš„æ— æœåŠ¡å™¨æ–‡ä»¶å¤¹åŒæ­¥ã€‚ä½¿ç”¨ UDP å¹¿æ’­å®ç°å±€åŸŸç½‘è‡ªåŠ¨å‘ç°ï¼Œè®¾å¤‡æ— éœ€æ‰‹åŠ¨é…ç½®å³å¯è‡ªåŠ¨è¿æ¥å’ŒåŒæ­¥ã€‚MST ä¿è¯äº†åœ¨æµ·é‡æ–‡ä»¶ä¸‹çš„å¿«é€ŸåŒæ­¥ä¸€è‡´æ€§ï¼Œè€Œ Vector Clocks ç¡®ä¿äº†åœ¨å¤šè®¾å¤‡å¹¶å‘ç¯å¢ƒä¸‹çš„ä¸€è‡´æ€§é€»è¾‘ã€‚
